<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.korigin.tobe.ias.mapper.ApprovalMapper">

     <!-- 결재 문서 등록 -->
    <insert id="insertApprovalDoc" parameterType="com.korigin.tobe.ias.dto.ApprovalDocDTO">
        <selectKey keyProperty="approvDocId" resultType="string" order="BEFORE">
            SELECT GET_NEXT_IAS_SEQ('IAS_APPROVAL_DOC');
        </selectKey>
        
        INSERT INTO IAS_APPROVAL_DOC (
            APPROV_DOC_ID, DOC_TITLE, DOC_CONTENT, REQ_USER_ID, REQ_USER_NM, REQ_DEPT_ID,
            APPROV_TY_CD, DOC_STAT_CD, CUR_APPR_USER_ID, VAC_STRT_DT, VAC_END_DT, HLF_TY_CD,
            ATCH_FILE_PATH, REG_DT, UPD_DT
        ) VALUES (
            #{approvDocId}, #{docTitle}, #{docContent}, #{reqUserId}, #{reqUserNm}, #{reqDeptId},
            #{approvTyCd}, #{docStatCd}, #{curApprUserId}, #{vacStrtDt}, #{vacEndDt}, #{hlfTyCd},
            #{atchFilePath}, NOW(), NOW()
        )
    </insert>

    <!-- 사용자 정보 조회 -->
    <select id="selectUserByUserId" parameterType="string" resultType="com.korigin.tobe.ias.dto.UserDTO">
        SELECT
            USR_ID AS userId,
            USR_NAME AS userName,
            DEPT_CD AS deptId
        FROM
            ias_user
        WHERE
            USR_ID = #{userId}
    </select>
    
    <select id="selectApprovalDocList" parameterType="com.korigin.tobe.ias.dto.ApprovalSearchDTO" resultType="com.korigin.tobe.ias.dto.ApprovalDocDTO">
        SELECT
            TAD.APPROV_DOC_ID         AS approvDocId,
            TAD.DOC_TITLE             AS docTitle,
            TAD.DOC_CONTENT           AS docContent,
            TAD.REQ_USER_ID           AS reqUserId,
            TAD.REQ_USER_NM           AS reqUserNm,
            TAD.REQ_DEPT_ID           AS reqDeptId,
            TAD.APPROV_TY_CD          AS approvTyCd,
            TAD.DOC_STAT_CD           AS docStatCd,
            TAD.CUR_APPR_USER_ID      AS curApprUserId,
            TAD.VAC_STRT_DT           AS vacStrtDt,
            TAD.VAC_END_DT            AS vacEndDt,
            TAD.HLF_TY_CD             AS hlfTyCd,
            TAD.ATCH_FILE_PATH        AS atchFilePath,
            TAD.REG_DT                AS regDt,
            TAD.UPD_DT                AS updDt,
            TAD.FINAL_APPR_DT         AS finalApprDt,
            TAD.DEL_YN                AS delYn,
            TADT.CODE_NAME            AS approvTyNm,
            TADS.CODE_NAME            AS docStatNm,
            TAHT.CODE_NAME            AS hlfTyNm,
            TADD.CODE_NAME            AS reqDeptNm
        FROM
            IAS_APPROVAL_DOC TAD
        LEFT JOIN
            IAS_CODE TADD ON TAD.REQ_DEPT_ID = TADD.CODE_VALUE AND TADD.GRP_CODE = 'DEPT'
        LEFT JOIN
            IAS_CODE TADT ON TAD.APPROV_TY_CD = TADT.CODE_VALUE AND TADT.GRP_CODE = 'APPROV_TY'
        LEFT JOIN
            IAS_CODE TADS ON TAD.DOC_STAT_CD = TADS.CODE_VALUE AND TADS.GRP_CODE = 'DOC_STAT'
        LEFT JOIN
            IAS_CODE TAHT ON TAD.HLF_TY_CD = TAHT.CODE_VALUE AND TAHT.GRP_CODE = 'HLF_TY'
        <where>
            TAD.DEL_YN = 'N'
            <if test="regDateFrom != null">
                AND TAD.REG_DT &gt;= #{regDateFrom}
            </if>
            <if test="regDateTo != null">
                AND TAD.REG_DT &lt;= CONCAT(#{regDateTo}, ' 23:59:59')
            </if>
            <if test="userName != null and userName != ''">
                AND TAD.REQ_USER_NM LIKE CONCAT('%', #{userName}, '%')
            </if>
            <if test="deptName != null and deptName != ''">
                AND TADD.CODE_NAME LIKE CONCAT('%', #{deptName}, '%')
            </if>
            <if test="approvalType != null and approvalType != ''">
                AND TAD.APPROV_TY_CD = #{approvalType}
            </if>
            <if test="approvalStatus != null and approvalStatus != ''">
                AND TAD.DOC_STAT_CD = #{approvalStatus}
            </if>
        </where>
        ORDER BY
            TAD.REG_DT DESC
    </select>
    
    <!-- (선택사항) 결재 상태 업데이트 시 최종 결재 일시도 업데이트 -->
    <update id="updateApprovalDocStatus">
        UPDATE
            IAS_APPROVAL_DOC
        SET
            DOC_STAT_CD = #{docStatCd},
            <if test="docStatCd == '40'">
            FINAL_APPR_DT = NOW(),
            </if>
            UPD_DT = NOW()
        WHERE
            APPROV_DOC_ID = #{approvDocId}
    </update>

    <!-- [추가] 결재 문서 삭제 (소프트 삭제) -->
    <update id="deleteApprovalDoc">
        UPDATE
            IAS_APPROVAL_DOC
        SET
            DEL_YN = 'Y',
            UPD_DT = NOW()
        WHERE
            APPROV_DOC_ID = #{approvDocId}
    </update>

    <select id="selectRequesterIdByDocId" parameterType="string" resultType="string">
        SELECT REQ_USER_ID
        FROM IAS_APPROVAL_DOC
        WHERE APPROV_DOC_ID = #{approvDocId}
    </select>

</mapper>